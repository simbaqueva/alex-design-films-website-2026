<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Wompi Integration</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }

        button:hover {
            background: #0056b3;
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .test-results {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üß™ Test de Integraci√≥n Wompi</h1>
        <p>Esta p√°gina prueba la integraci√≥n con Wompi para identificar y solucionar problemas.</p>

        <div id="status-container"></div>

        <div class="test-section">
            <h2>üìã Pruebas Disponibles</h2>
            <button onclick="testScriptLoading()" id="test-script-btn">
                1. Probar Carga del Script
            </button>
            <button onclick="testWidgetCheckout()" id="test-widget-btn" disabled>
                2. Probar WidgetCheckout
            </button>
            <button onclick="testFullIntegration()" id="test-full-btn" disabled>
                3. Probar Integraci√≥n Completa
            </button>
            <button onclick="testCheckoutFlow()" id="test-checkout-btn" disabled>
                4. Probar Flujo de Pago (Test)
            </button>
            <button onclick="testSandboxData()" id="test-sandbox-btn" disabled>
                5. Ver Datos de Prueba Sandbox
            </button>
        </div>

        <div class="test-results" id="results" style="display: none;">
            <h2>üìä Resultados de las Pruebas</h2>
            <div id="results-content"></div>
        </div>
    </div>

    <script type="module">
        // Importar m√≥dulos
        import { WOMPI_CONFIG } from './assets/js/config/wompi-config.js';
        import { WompiIntegration, initializeWompi } from './assets/js/modules/wompi-integration.js';
        import { initializeWompiErrorHandler } from './assets/js/modules/wompi-error-handler.js';

        // Variables globales
        let wompiIntegration = null;
        let testResults = [];

        // Funci√≥n para mostrar estado
        function showStatus(message, type = 'info') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            document.getElementById('status-container').appendChild(statusDiv);

            // Auto-ocultar despu√©s de 5 segundos para mensajes de √©xito
            if (type === 'success') {
                setTimeout(() => statusDiv.remove(), 5000);
            }
        }

        // Funci√≥n para agregar resultado de prueba
        function addTestResult(testName, passed, details = '') {
            testResults.push({ testName, passed, details, timestamp: new Date() });
            updateResultsDisplay();
        }

        // Funci√≥n para actualizar display de resultados
        function updateResultsDisplay() {
            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');

            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = testResults.map(result => `
                <div class="status ${result.passed ? 'success' : 'error'}">
                    <strong>${result.testName}:</strong> 
                    ${result.passed ? '‚úÖ PAS√ì' : '‚ùå FALL√ì'}
                    ${result.details ? `<br><small>${result.details}</small>` : ''}
                </div>
            `).join('');
        }

        // Test 1: Carga del script
        window.testScriptLoading = async function () {
            const btn = document.getElementById('test-script-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>Probando...';

            try {
                showStatus('üîÑ Iniciando prueba de carga del script Wompi...', 'info');

                // Verificar si el script ya est√° cargado
                if (window.WidgetCheckout) {
                    showStatus('‚úÖ Script ya estaba cargado', 'success');
                    addTestResult('Carga de Script', true, 'Script ya disponible en window.WidgetCheckout');
                    document.getElementById('test-widget-btn').disabled = false;
                    return;
                }

                // Cargar el script manualmente
                const script = document.createElement('script');
                script.src = 'https://checkout.wompi.co/widget.js';
                script.async = true;

                const loadPromise = new Promise((resolve, reject) => {
                    script.onload = () => {
                        showStatus('‚úÖ Script cargado exitosamente', 'success');
                        resolve(true);
                    };
                    script.onerror = (error) => {
                        showStatus('‚ùå Error al cargar el script', 'error');
                        reject(error);
                    };
                });

                document.head.appendChild(script);
                await loadPromise;

                // Esperar a que WidgetCheckout est√© disponible
                let attempts = 0;
                const maxAttempts = 30;

                while (!window.WidgetCheckout && attempts < maxAttempts) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                    attempts++;
                }

                if (window.WidgetCheckout) {
                    showStatus(`‚úÖ WidgetCheckout disponible despu√©s de ${attempts * 200}ms`, 'success');
                    addTestResult('Carga de Script', true, `Disponible en ${attempts * 200}ms`);
                    document.getElementById('test-widget-btn').disabled = false;
                } else {
                    throw new Error('WidgetCheckout no disponible despu√©s de esperar');
                }

            } catch (error) {
                showStatus(`‚ùå Error en prueba de script: ${error.message}`, 'error');
                addTestResult('Carga de Script', false, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '1. Probar Carga del Script';
            }
        };

        // Test 2: WidgetCheckout
        window.testWidgetCheckout = async function () {
            const btn = document.getElementById('test-widget-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>Probando...';

            try {
                showStatus('üîÑ Probando WidgetCheckout...', 'info');

                if (!window.WidgetCheckout) {
                    throw new Error('WidgetCheckout no disponible');
                }

                // Verificar que sea una funci√≥n
                if (typeof window.WidgetCheckout !== 'function') {
                    throw new Error('WidgetCheckout no es una funci√≥n');
                }

                // Intentar crear una instancia sin abrir
                const testConfig = {
                    currency: 'COP',
                    amountInCents: 10000, // $100
                    reference: 'TEST-' + Date.now(),
                    publicKey: WOMPI_CONFIG.getPublicKey()
                };

                const testCheckout = new window.WidgetCheckout(testConfig);

                if (testCheckout && typeof testCheckout.open === 'function') {
                    showStatus('‚úÖ WidgetCheckout funciona correctamente', 'success');
                    addTestResult('WidgetCheckout', true, 'Instancia creada exitosamente');
                    document.getElementById('test-full-btn').disabled = false;
                } else {
                    throw new Error('WidgetCheckout no tiene m√©todo open');
                }

            } catch (error) {
                showStatus(`‚ùå Error en WidgetCheckout: ${error.message}`, 'error');
                addTestResult('WidgetCheckout', false, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '2. Probar WidgetCheckout';
            }
        };

        // Test 3: Integraci√≥n completa
        window.testFullIntegration = async function () {
            const btn = document.getElementById('test-full-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>Probando...';

            try {
                showStatus('üîÑ Probando integraci√≥n completa...', 'info');

                // Inicializar integraci√≥n
                wompiIntegration = initializeWompi(WOMPI_CONFIG.getWompiConfig());

                // Esperar inicializaci√≥n
                const initialized = await wompiIntegration.initialize();

                if (!initialized) {
                    throw new Error('No se pudo inicializar la integraci√≥n');
                }

                showStatus('‚úÖ Integraci√≥n inicializada correctamente', 'success');
                addTestResult('Integraci√≥n Completa', true, 'WompiIntegration inicializado');
                document.getElementById('test-checkout-btn').disabled = false;
                document.getElementById('test-sandbox-btn').disabled = false;

            } catch (error) {
                showStatus(`‚ùå Error en integraci√≥n completa: ${error.message}`, 'error');
                addTestResult('Integraci√≥n Completa', false, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '3. Probar Integraci√≥n Completa';
            }
        };

        // Test 4: Flujo de pago (simulado)
        window.testCheckoutFlow = async function () {
            const btn = document.getElementById('test-checkout-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>Probando...';

            try {
                showStatus('üîÑ Probando flujo de pago (simulado)...', 'info');

                if (!wompiIntegration) {
                    throw new Error('WompiIntegration no inicializado');
                }

                // Datos de prueba
                const orderData = {
                    total: 100.00, // $100 COP
                    subtotal: 84.03,
                    tax: 15.97,
                    items: [
                        {
                            id: 'test-item',
                            name: 'Producto de Prueba',
                            price: 100.00,
                            quantity: 1
                        }
                    ],
                    itemCount: 1,
                    customerEmail: 'test@example.com',
                    customerName: 'Usuario de Prueba',
                    customerPhone: '3001234567',
                    customerDocument: '1234567890'
                };

                showStatus('üìã Abriendo checkout de prueba...', 'info');

                // Abrir checkout
                const reference = await wompiIntegration.openCheckout(orderData);

                showStatus(`‚úÖ Checkout abierto con referencia: ${reference}`, 'success');
                addTestResult('Flujo de Pago', true, `Referencia: ${reference}`);

            } catch (error) {
                showStatus(`‚ùå Error en flujo de pago: ${error.message}`, 'error');
                addTestResult('Flujo de Pago', false, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '4. Probar Flujo de Pago (Test)';
            }
        };

        // Test 5: Mostrar datos de prueba Sandbox
        window.testSandboxData = function () {
            const btn = document.getElementById('test-sandbox-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading"></div>Mostrando...';

            try {
                showStatus('üìã Mostrando datos de prueba oficiales...', 'info');

                // Crear modal o secci√≥n con los datos de prueba
                const sandboxDataHTML = `
                    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px; border: 1px solid #dee2e6;">
                        <h3>üß™ Datos de Prueba Oficiales Wompi Sandbox</h3>
                        
                        <h4>üí≥ Tarjetas de Cr√©dito/D√©bito</h4>
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <p><strong>Tarjeta Aprobada:</strong> 4242 4242 4242 4242</p>
                            <p><strong>Tarjeta Declinada:</strong> 4111 1111 1111 1111</p>
                            <p><em>Cualquier fecha futura y CVC de 3 d√≠gitos son v√°lidos</em></p>
                        </div>

                        <h4>üì± Nequi</h4>
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <p><strong>Tel√©fono Aprobado:</strong> 3991111111</p>
                            <p><strong>Tel√©fono Declinado:</strong> 3992222222</p>
                        </div>

                        <h4>üè¶ PSE</h4>
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <p><strong>Banco que aprueba:</strong> Transacci√≥n APROBADA</p>
                            <p><strong>Banco que rechaza:</strong> Transacci√≥n DECLINADA</p>
                        </div>

                        <h4>üí∞ Daviplata</h4>
                        <div style="background: white; padding: 15px; margin: 10px 0; border-radius: 5px;">
                            <p><strong>OTP Aprobado:</strong> 574829</p>
                            <p><strong>OTP Declinado:</strong> 932015</p>
                        </div>

                        <div style="margin-top: 15px; padding: 15px; background: #d1ecf1; border-radius: 5px;">
                            <p><strong>üìù Nota:</strong> Estos datos solo funcionan en modo Sandbox con llave p√∫blica <code>pub_test_</code></p>
                            <p><strong>üìö Documentaci√≥n completa:</strong> <a href="./WOMPI_DATOS_PRUEBA.md" target="_blank">WOMPI_DATOS_PRUEBA.md</a></p>
                        </div>
                    </div>
                `;

                // Agregar al contenedor de resultados
                const resultsDiv = document.getElementById('results');
                const resultsContent = document.getElementById('results-content');

                resultsDiv.style.display = 'block';
                resultsContent.innerHTML = sandboxDataHTML;

                showStatus('‚úÖ Datos de prueba mostrados', 'success');
                addTestResult('Datos de Prueba', true, 'Datos oficiales de Wompi Sandbox');

            } catch (error) {
                showStatus(`‚ùå Error al mostrar datos de prueba: ${error.message}`, 'error');
                addTestResult('Datos de Prueba', false, error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '5. Ver Datos de Prueba Sandbox';
            }
        };

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            showStatus('üöÄ P√°gina de pruebas lista', 'success');

            // Inicializar manejador de errores de Wompi
            try {
                initializeWompiErrorHandler();
                showStatus('üõ°Ô∏è Manejador de errores de Wompi inicializado', 'success');
            } catch (error) {
                showStatus(`‚ùå Error al inicializar manejador de errores: ${error.message}`, 'error');
            }

            // Verificar configuraci√≥n
            try {
                const config = WOMPI_CONFIG.getWompiConfig();
                showStatus(`‚úÖ Configuraci√≥n Wompi: ${config.sandbox ? 'Sandbox' : 'Producci√≥n'}`, 'info');
            } catch (error) {
                showStatus(`‚ùå Error en configuraci√≥n: ${error.message}`, 'error');
            }
        });

        // Exportar para debugging
        window.wompiTestDebug = {
            WompiIntegration,
            WOMPI_CONFIG,
            wompiIntegration
        };
    </script>
</body>

</html>